<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="description" content="Smart Agenda - Professional CRM System">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Smart Agenda</title>
    
    <!-- Quill Editor for Rich Text -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- Main Styles -->
    <link rel="stylesheet" href="style.css">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icon.png">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <p>Loading Smart Agenda...</p>
    </div>

    <!-- App Container -->
    <div id="app" class="app-container" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <button class="menu-button" id="menu-button" aria-label="Menu">
                <span class="hamburger-icon"></span>
            </button>
            <div class="header-title">
                <span class="header-icon">üìä</span>
                <h1 id="header-title">Smart Agenda</h1>
            </div>
        </header>

        <!-- Navigation Menu -->
        <nav class="nav-menu" id="nav-menu">
            <div class="nav-header">
                <div class="user-profile">
                    <div class="user-avatar" id="user-avatar">üë§</div>
                    <div class="user-info">
                        <div class="user-name" id="user-name">Guest User</div>
                        <div class="user-email" id="user-email">Not signed in</div>
                    </div>
                </div>
            </div>
            
            <div class="nav-items">
                <button class="nav-item active" data-tab="home">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-label" data-i18n="nav.home">Home</span>
                </button>
                <button class="nav-item" data-tab="clients">
                    <span class="nav-icon">üë•</span>
                    <span class="nav-label" data-i18n="nav.clients">Clients</span>
                </button>
                <button class="nav-item" data-tab="appointments">
                    <span class="nav-icon">üìÖ</span>
                    <span class="nav-label" data-i18n="nav.appointments">Appointments</span>
                </button>
                <button class="nav-item" data-tab="tasks">
                    <span class="nav-icon">‚úì</span>
                    <span class="nav-label" data-i18n="nav.tasks">Tasks</span>
                </button>
                <button class="nav-item" data-tab="map">
                    <span class="nav-icon">üó∫Ô∏è</span>
                    <span class="nav-label" data-i18n="nav.map">Map</span>
                </button>
                <button class="nav-item" data-tab="finance">
                    <span class="nav-icon">üí∞</span>
                    <span class="nav-label" data-i18n="nav.finance">Finance</span>
                </button>
                <button class="nav-item" data-tab="calendar">
                    <span class="nav-icon">üìÜ</span>
                    <span class="nav-label" data-i18n="nav.calendar">Calendar</span>
                </button>
                <button class="nav-item" data-tab="advanced">
                    <span class="nav-icon">‚ö°</span>
                    <span class="nav-label" data-i18n="nav.advanced">Advanced</span>
                </button>
                <button class="nav-item" data-tab="settings">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span class="nav-label" data-i18n="nav.settings">Settings</span>
                </button>
            </div>

            <div class="nav-footer">
                <!-- Spacer box matching ad + navigation bar height -->
                <div class="nav-spacer" id="nav-spacer"></div>
            </div>
        </nav>

        <!-- Menu Overlay -->
        <div class="menu-overlay" id="menu-overlay"></div>

        <!-- Main Content -->
        <main class="main-content" id="main-content">
            <!-- Home Tab -->
            <section class="tab-content active" id="home-tab">
                <div class="dashboard-container">
                    <h2 class="dashboard-title" data-i18n="dashboard.title">Dashboard</h2>
                    
                    <!-- Revenue Forecast -->
                    <div class="dashboard-section">
                        <h3 data-i18n="dashboard.revenue_forecast">Revenue Forecast (Next 30 Days)</h3>
                        <div id="revenue-forecast" class="forecast-container"></div>
                    </div>

                    <!-- Upcoming Appointments -->
                    <div class="dashboard-section">
                        <div class="section-header">
                            <h3 data-i18n="dashboard.upcoming_appointments">Upcoming Appointments</h3>
                            <button class="btn-link" onclick="SmartAgenda.Navigation.switchTab('appointments')">
                                <span data-i18n="actions.view_all">View All</span> ‚Üí
                            </button>
                        </div>
                        <div id="dashboard-appointments" class="dashboard-list"></div>
                    </div>

                    <!-- Pending Tasks -->
                    <div class="dashboard-section">
                        <div class="section-header">
                            <h3 data-i18n="dashboard.pending_tasks">Pending Tasks</h3>
                            <button class="btn-link" onclick="SmartAgenda.Navigation.switchTab('tasks')">
                                <span data-i18n="actions.view_all">View All</span> ‚Üí
                            </button>
                        </div>
                        <div id="dashboard-tasks" class="dashboard-list"></div>
                    </div>

                    <!-- Analytics -->
                    <div class="dashboard-section">
                        <h3 data-i18n="dashboard.analytics">Analytics</h3>

                        <!-- Top Clients -->
                        <div class="analytics-subsection">
                            <h4 style="font-size: 15px; margin-bottom: 12px; color: var(--text-secondary);" data-i18n="dashboard.top_clients">Top Clients by Revenue</h4>
                            <div id="top-clients-list" class="top-clients-list"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Clients Tab -->
            <section class="tab-content" id="clients-tab">
                <div class="tab-header">
                    <div class="search-bar">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="clients-search" placeholder="Search clients..." data-i18n-placeholder="search.clients">
                        <button class="search-clear-btn" id="clients-search-clear" style="display: none;" aria-label="Clear search">‚úï</button>
                    </div>
                    <div class="tab-actions">
                        <button class="btn-icon" id="clients-sort-btn" aria-label="Sort">
                            <span>‚¨ç</span>
                            <span data-i18n="actions.sort">Sort</span>
                        </button>
                        <button class="btn-icon" id="clients-filter-btn" aria-label="Filter">
                            <span>üîΩ</span>
                            <span data-i18n="actions.filter">Filters</span>
                        </button>
                        <button class="btn-primary" id="clients-add-btn">
                            <span>+</span>
                            <span data-i18n="actions.add">Add</span>
                        </button>
                    </div>
                </div>
                <div id="clients-search-indicator" class="search-result-indicator" style="display: none;">
                    <span>üîç Search results</span>
                </div>
                <div class="items-list" id="clients-list">
                    <!-- Client items will be rendered here -->
                </div>
            </section>

            <!-- Appointments Tab -->
            <section class="tab-content" id="appointments-tab">
                <div class="tab-header">
                    <div class="search-bar">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="appointments-search" placeholder="Search appointments..." data-i18n-placeholder="search.appointments">
                        <button class="search-clear-btn" id="appointments-search-clear" style="display: none;" aria-label="Clear search">‚úï</button>
                    </div>
                    <div class="tab-actions">
                        <button class="btn-icon" id="appointments-filter-btn" aria-label="Filter">
                            <span>üîΩ</span>
                            <span data-i18n="actions.filter">Filters</span>
                        </button>
                        <button class="btn-primary" id="appointments-add-btn">
                            <span>+</span>
                            <span data-i18n="actions.add">Add</span>
                        </button>
                    </div>
                </div>
                <div id="appointments-search-indicator" class="search-result-indicator" style="display: none;">
                    <span>üîç Search results</span>
                </div>
                <div class="items-list" id="appointments-list">
                    <!-- Appointment items will be rendered here -->
                </div>
            </section>

            <!-- Tasks Tab -->
            <section class="tab-content" id="tasks-tab">
                <div class="tab-header">
                    <div class="search-bar">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="tasks-search" placeholder="Search tasks..." data-i18n-placeholder="search.tasks">
                        <button class="search-clear-btn" id="tasks-search-clear" style="display: none;" aria-label="Clear search">‚úï</button>
                    </div>
                    <div class="tab-actions">
                        <button class="btn-icon" id="tasks-filter-btn" aria-label="Filter">
                            <span>üîΩ</span>
                            <span data-i18n="actions.filter">Filters</span>
                        </button>
                        <button class="btn-primary" id="tasks-add-btn">
                            <span>+</span>
                            <span data-i18n="actions.add">Add</span>
                        </button>
                    </div>
                </div>
                <div id="tasks-search-indicator" class="search-result-indicator" style="display: none;">
                    <span>üîç Search results</span>
                </div>
                <div class="items-list" id="tasks-list">
                    <!-- Task items will be rendered here -->
                </div>
            </section>

            <!-- Map Tab -->
            <section class="tab-content" id="map-tab">
                <div class="tab-header" id="map-header" style="padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--surface);">
                    <div id="map-controls-header" style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                        <!-- Map controls will be inserted here -->
                    </div>
                </div>
                <div class="map-container">
                    <div id="map-loading">
                        <div style="font-size: 48px; margin-bottom: 16px;">üó∫Ô∏è</div>
                        <div style="color: var(--text-secondary); font-size: 14px;">Loading map...</div>
                    </div>
                    <div id="map"></div>
                </div>
            </section>

            <!-- Finance Tab -->
            <section class="tab-content" id="finance-tab">
                <div class="calendar-view" id="finance-calendar">
                    <!-- Finance calendar will be rendered here -->
                </div>
            </section>

            <!-- Calendar Tab -->
            <section class="tab-content" id="calendar-tab">
                <div class="calendar-view" id="appointments-calendar">
                    <!-- Appointments calendar will be rendered here -->
                </div>
            </section>

            <!-- Advanced Tab -->
            <section class="tab-content" id="advanced-tab">
                <div class="advanced-container">
                    <h2 class="dashboard-title" data-i18n="advanced.title">Advanced Operations</h2>

                    <!-- Bulk Operations -->
                    <div class="dashboard-section">
                        <h3 data-i18n="advanced.bulk_operations">Bulk Operations</h3>

                        <div class="bulk-operations-section">
                            <h4 style="font-size: 15px; margin-bottom: 12px; color: var(--text-secondary);" data-i18n="advanced.clients">Clients</h4>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <button class="btn-secondary" id="bulk-export-clients-btn">
                                    <span>üì§</span>
                                    <span data-i18n="advanced.export_xls">Export XLS</span>
                                </button>
                                <button class="btn-secondary" id="bulk-export-vcf-btn">
                                    <span>üìá</span>
                                    <span data-i18n="advanced.export_vcf">Export Contacts VCF</span>
                                </button>
                                <button class="btn-secondary" id="bulk-delete-clients-btn">
                                    <span>üóëÔ∏è</span>
                                    <span data-i18n="advanced.delete_selected">Delete Selected</span>
                                </button>
                                <button class="btn-secondary" id="bulk-update-type-btn">
                                    <span>üè∑Ô∏è</span>
                                    <span data-i18n="advanced.update_type">Update Type</span>
                                </button>
                            </div>
                            <div id="clients-bulk-list" class="bulk-selection-list" style="margin-top: 16px;"></div>
                        </div>

                        <div class="bulk-operations-section" style="margin-top: 24px;">
                            <h4 style="font-size: 15px; margin-bottom: 12px; color: var(--text-secondary);" data-i18n="advanced.appointments">Appointments</h4>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <button class="btn-secondary" id="bulk-export-appointments-btn">
                                    <span>üì§</span>
                                    <span data-i18n="advanced.export_xls">Export XLS</span>
                                </button>
                                <button class="btn-secondary" id="bulk-update-status-btn">
                                    <span>‚úì</span>
                                    <span data-i18n="advanced.update_status">Update Status</span>
                                </button>
                                <button class="btn-secondary" id="bulk-delete-appointments-btn">
                                    <span>üóëÔ∏è</span>
                                    <span data-i18n="advanced.delete_selected">Delete Selected</span>
                                </button>
                            </div>
                            <div id="appointments-bulk-list" class="bulk-selection-list" style="margin-top: 16px;"></div>
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div class="dashboard-section">
                        <h3 data-i18n="advanced.data_management">Data Management</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                            <div style="padding: 16px; background: var(--surface); border-radius: 8px; border: 1px solid var(--border);">
                                <h4 style="margin-bottom: 8px;" data-i18n="advanced.database_stats">Database Statistics</h4>
                                <div id="database-stats"></div>
                            </div>
                            <div style="padding: 16px; background: var(--surface); border-radius: 8px; border: 1px solid var(--border);">
                                <h4 style="margin-bottom: 8px;" data-i18n="advanced.storage_usage">Storage Usage</h4>
                                <div id="storage-usage"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Tab -->
            <section class="tab-content" id="settings-tab">
                <div class="settings-container">
                    <div class="settings-section">
                        <h2 data-i18n="settings.appearance">Appearance</h2>
                        <div class="setting-item">
                            <label data-i18n="settings.theme">Theme</label>
                            <select id="theme-select">
                                <option value="light" data-i18n="settings.light">Light</option>
                                <option value="dark" data-i18n="settings.dark">Dark</option>
                                <option value="kouzmidis">Kouzmidis</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label data-i18n="settings.language">Language</label>
                            <select id="language-select">
                                <option value="en">English</option>
                                <option value="el">ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨</option>
                                <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label data-i18n="settings.currency">Currency</label>
                            <select id="currency-select">
                                <option value="‚Ç¨">Euro (‚Ç¨)</option>
                                <option value="$">US Dollar ($)</option>
                                <option value="¬£">British Pound (¬£)</option>
                                <option value="‚ÇΩ">Russian Ruble (‚ÇΩ)</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label data-i18n="settings.font_size">Font Size</label>
                            <select id="font-size-select">
                                <option value="small" data-i18n="settings.font_small">Small</option>
                                <option value="medium" data-i18n="settings.font_medium">Medium (Default)</option>
                                <option value="large" data-i18n="settings.font_large">Large</option>
                                <option value="extra-large" data-i18n="settings.font_extra_large">Extra Large</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h2 data-i18n="notifications.title">Notifications</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 16px;" data-i18n="notifications.description">Receive reminders before your appointments</p>
                        <div class="setting-item">
                            <label for="notifications-enabled" data-i18n="notifications.enabled">Enable Notifications</label>
                            <select id="notifications-enabled">
                                <option value="true" data-i18n="settings.enabled">Enabled</option>
                                <option value="false" data-i18n="settings.disabled">Disabled</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label for="notification-time" data-i18n="notifications.remind_before">Remind me before</label>
                            <select id="notification-time">
                                <option value="10" data-i18n="notifications.10min">10 minutes</option>
                                <option value="30" data-i18n="notifications.30min">30 minutes</option>
                                <option value="60" data-i18n="notifications.1hour">1 hour</option>
                                <option value="120" data-i18n="notifications.2hours">2 hours</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h2 data-i18n="settings.client_types">Client Types</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 16px;" data-i18n="settings.client_types_desc">Manage custom client types and colors (up to 6 types)</p>
                        <div id="client-types-list"></div>
                        <button class="btn-primary" id="add-client-type-btn" style="margin-top: 12px;">
                            <span>+</span>
                            <span data-i18n="settings.add_client_type">Add Client Type</span>
                        </button>
                    </div>

                    <div class="settings-section">
                        <h2 data-i18n="settings.data">Data Management</h2>
                        <div class="setting-buttons">
                            <button class="btn-secondary" id="export-data-btn">
                                <span>üì§</span>
                                <span data-i18n="settings.export">Export Data</span>
                            </button>
                            <button class="btn-secondary" id="import-data-btn">
                                <span>üì•</span>
                                <span data-i18n="settings.import">Import Data</span>
                            </button>
                            <button class="btn-danger" id="clear-data-btn">
                                <span>üóëÔ∏è</span>
                                <span data-i18n="settings.clear">Clear All Data</span>
                            </button>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h2 data-i18n="settings.account">Account</h2>
                        <div class="setting-buttons" id="auth-buttons">
                            <button class="btn-primary" id="signin-btn">
                                <span>üîê</span>
                                <span data-i18n="settings.signin">Sign In</span>
                            </button>
                            <button class="btn-secondary" id="create-account-btn">
                                <span>‚ú®</span>
                                <span data-i18n="settings.create_account">Create Account</span>
                            </button>
                            <button class="btn-danger" id="signout-btn" style="display: none;">
                                <span>üö™</span>
                                <span data-i18n="settings.signout">Sign Out</span>
                            </button>
                        </div>
                        <div class="setting-buttons" style="margin-top: 12px;">
                            <button class="btn-secondary" id="backup-data-btn" style="display: none;">
                                <span>‚òÅÔ∏è</span>
                                <span data-i18n="settings.backup">Backup to Cloud</span>
                            </button>
                            <button class="btn-secondary" id="restore-data-btn" style="display: none;">
                                <span>üì•</span>
                                <span data-i18n="settings.restore">Restore from Cloud</span>
                            </button>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h2 data-i18n="settings.about">About</h2>
                        <p class="version-info">Version 2.0.0</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- External Libraries -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

    <!-- Core Scripts -->
    <script src="core.js"></script>
    <script src="i18n.js"></script>
    <script src="data-management.js"></script>
    <script src="ui-components.js"></script>
    <script src="firebase-service.js"></script>
    <script src="admob-service.js"></script>
    <script src="virtual-scroll.js"></script>
    <script src="quick-actions.js"></script>
    <script src="home.js"></script>
    <script src="client-detail-view.js"></script>
    <script src="clients.js"></script>
    <script src="appointments.js"></script>
    <script src="tasks.js"></script>
    <script src="maps.js"></script>
    <script src="calendar-views.js"></script>
    <script src="advanced.js"></script>
    <script src="notifications.js"></script>
    <script src="settings.js"></script>

    <!-- App Initialization -->
    <script>
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            SmartAgenda.init();
        });

        // Service Worker Registration with update detection
        if ('serviceWorker' in navigator) {
            let refreshing = false;

            // Detect controller change and reload the page
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                refreshing = true;
                console.log('[App] New service worker activated, reloading page...');
                window.location.reload();
            });

            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => {
                        console.log('[App] Service Worker registered');

                        // Check for updates every 30 seconds when app is active
                        setInterval(() => {
                            reg.update();
                        }, 30000);

                        // Listen for updates
                        reg.addEventListener('updatefound', () => {
                            const newWorker = reg.installing;
                            console.log('[App] New service worker installing...');

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available, show update notification
                                    console.log('[App] New version available!');

                                    // Show toast notification if available
                                    if (window.SmartAgenda && window.SmartAgenda.Toast) {
                                        window.SmartAgenda.Toast.info('A new version is available. The app will update automatically.', 5000);
                                    }

                                    // Automatically activate the new service worker
                                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                                }
                            });
                        });
                    })
                    .catch(err => console.log('[App] Service Worker registration failed:', err));
            });
        }
    </script>
</body>
</html>
